<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 1070" font-family="system-ui, -apple-system, sans-serif" font-size="13">
  <defs>
    <marker id="arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#334155"/>
    </marker>
    <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#16a34a"/>
    </marker>
    <marker id="arrow-orange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#ea580c"/>
    </marker>
    <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#2563eb"/>
    </marker>
    <marker id="arrow-purple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#7c3aed"/>
    </marker>
    <marker id="arrow-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#e11d48"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1100" height="1070" fill="#fafafa" rx="8"/>

  <!-- Title -->
  <text x="550" y="35" text-anchor="middle" font-size="20" font-weight="bold" fill="#0f172a">Tollbooth — Protocol Flow</text>
  <text x="550" y="55" text-anchor="middle" font-size="12" fill="#64748b">thebrain-mcp: OAuth identity + Lightning micropayments (sat-denominated)</text>

  <!-- Swim lane headers -->
  <g font-size="12" font-weight="bold" text-anchor="middle">
    <rect x="50" y="70" width="120" height="36" rx="6" fill="#dbeafe" stroke="#2563eb" stroke-width="1.5"/>
    <text x="110" y="93" fill="#1e40af">Claude</text>

    <rect x="230" y="70" width="120" height="36" rx="6" fill="#fef3c7" stroke="#d97706" stroke-width="1.5"/>
    <text x="290" y="93" fill="#92400e">Horizon</text>

    <rect x="420" y="70" width="140" height="36" rx="6" fill="#dcfce7" stroke="#16a34a" stroke-width="1.5"/>
    <text x="490" y="88" fill="#166534">thebrain-mcp</text>
    <text x="490" y="100" font-size="9" font-weight="normal" fill="#166534">(FastMCP server)</text>

    <rect x="630" y="70" width="130" height="36" rx="6" fill="#fae8ff" stroke="#7c3aed" stroke-width="1.5"/>
    <text x="695" y="88" fill="#581c87">BTCPay Server</text>
    <text x="695" y="100" font-size="9" font-weight="normal" fill="#581c87">(Greenfield API)</text>

    <rect x="830" y="70" width="130" height="36" rx="6" fill="#fff1f2" stroke="#e11d48" stroke-width="1.5"/>
    <text x="895" y="93" fill="#9f1239">TheBrain API</text>
  </g>

  <!-- Vertical lifelines -->
  <g stroke="#cbd5e1" stroke-width="1" stroke-dasharray="6,4">
    <line x1="110" y1="110" x2="110" y2="1045"/>
    <line x1="290" y1="110" x2="290" y2="1045"/>
    <line x1="490" y1="110" x2="490" y2="1045"/>
    <line x1="695" y1="110" x2="695" y2="1045"/>
    <line x1="895" y1="110" x2="895" y2="1045"/>
  </g>

  <!-- ═══ Phase 1: OAuth Authentication ═══ -->
  <rect x="30" y="120" width="1040" height="130" rx="4" fill="#eff6ff" fill-opacity="0.5" stroke="#bfdbfe" stroke-width="1"/>
  <text x="45" y="140" font-size="13" font-weight="bold" fill="#1e40af">Phase 1: OAuth Authentication</text>

  <line x1="115" y1="160" x2="282" y2="160" stroke="#2563eb" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
  <text x="198" y="155" text-anchor="middle" font-size="11" fill="#2563eb">MCP connect request</text>

  <line x1="285" y1="185" x2="118" y2="185" stroke="#d97706" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-orange)"/>
  <text x="198" y="180" text-anchor="middle" font-size="11" fill="#d97706">OAuth consent redirect</text>

  <line x1="115" y1="210" x2="282" y2="210" stroke="#2563eb" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
  <text x="198" y="205" text-anchor="middle" font-size="11" fill="#2563eb">User authenticates</text>

  <line x1="285" y1="235" x2="118" y2="235" stroke="#d97706" stroke-width="1.5" marker-end="url(#arrow-orange)"/>
  <text x="198" y="230" text-anchor="middle" font-size="11" fill="#d97706">Bearer token issued</text>

  <!-- ═══ Phase 2: Session & Credential Setup ═══ -->
  <rect x="30" y="260" width="1040" height="165" rx="4" fill="#f0fdf4" fill-opacity="0.5" stroke="#bbf7d0" stroke-width="1"/>
  <text x="45" y="280" font-size="13" font-weight="bold" fill="#166534">Phase 2: Session &amp; Credential Setup</text>
  <text x="45" y="293" font-size="10" fill="#64748b">BTCPay config from operator env vars (BTCPAY_HOST, BTCPAY_STORE_ID, BTCPAY_API_KEY)</text>

  <line x1="115" y1="315" x2="482" y2="315" stroke="#16a34a" stroke-width="1.5" marker-end="url(#arrow-green)"/>
  <text x="298" y="310" text-anchor="middle" font-size="11" fill="#16a34a">register_credentials(api_key, brain_id, passphrase)</text>

  <line x1="498" y1="335" x2="887" y2="335" stroke="#e11d48" stroke-width="1.5" marker-end="url(#arrow-red)"/>
  <text x="692" y="330" text-anchor="middle" font-size="11" fill="#e11d48">encrypt + store in credential vault</text>
  <text x="692" y="348" text-anchor="middle" font-size="9" fill="#64748b">first-time only — one-time setup</text>

  <line x1="60" y1="362" x2="1040" y2="362" stroke="#bbf7d0" stroke-width="0.5" stroke-dasharray="3,3"/>

  <line x1="115" y1="382" x2="482" y2="382" stroke="#16a34a" stroke-width="1.5" marker-end="url(#arrow-green)"/>
  <text x="298" y="377" text-anchor="middle" font-size="11" fill="#16a34a">activate_session(passphrase)</text>

  <line x1="498" y1="400" x2="887" y2="400" stroke="#e11d48" stroke-width="1.5" marker-end="url(#arrow-red)"/>
  <text x="692" y="395" text-anchor="middle" font-size="11" fill="#e11d48">fetch + decrypt from vault → session active</text>
  <text x="692" y="413" text-anchor="middle" font-size="9" fill="#64748b">each session — returns user's TheBrain credentials</text>

  <!-- ═══ Balance Gate: triggers credit purchase ═══ -->
  <rect x="30" y="433" width="1040" height="62" rx="4" fill="#fffbeb" fill-opacity="0.6" stroke="#fbbf24" stroke-width="1"/>
  <text x="45" y="452" font-size="13" font-weight="bold" fill="#92400e">Balance Gate</text>
  <text x="175" y="452" font-size="10" fill="#64748b">— paid tool call triggers credit purchase</text>

  <line x1="115" y1="470" x2="482" y2="470" stroke="#ea580c" stroke-width="1.5" marker-end="url(#arrow-orange)"/>
  <text x="298" y="465" text-anchor="middle" font-size="11" fill="#ea580c">search_thoughts("quantum")</text>

  <line x1="483" y1="488" x2="118" y2="488" stroke="#ea580c" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-orange)"/>
  <text x="298" y="483" text-anchor="middle" font-size="11" fill="#ea580c">Insufficient balance (0 sats) — use purchase_credits</text>

  <!-- ═══ Phase 3: Credit Purchase via Lightning ═══ -->
  <rect x="30" y="503" width="1040" height="290" rx="4" fill="#faf5ff" fill-opacity="0.5" stroke="#e9d5ff" stroke-width="1"/>
  <text x="45" y="523" font-size="13" font-weight="bold" fill="#581c87">Phase 3: Credit Purchase via Lightning</text>

  <!-- 3a: Claude → thebrain-mcp: purchase_credits -->
  <line x1="115" y1="546" x2="482" y2="546" stroke="#7c3aed" stroke-width="1.5" marker-end="url(#arrow-purple)"/>
  <text x="298" y="541" text-anchor="middle" font-size="11" fill="#7c3aed">purchase_credits(amount_sats=1000)</text>

  <!-- 3b: thebrain-mcp → BTCPay: POST /invoices -->
  <line x1="498" y1="566" x2="687" y2="566" stroke="#7c3aed" stroke-width="1.5" marker-end="url(#arrow-purple)"/>
  <text x="592" y="561" text-anchor="middle" font-size="11" fill="#7c3aed">POST /stores/{id}/invoices (1000 SATS)</text>

  <!-- 3c: BTCPay → thebrain-mcp: invoice response -->
  <line x1="688" y1="586" x2="498" y2="586" stroke="#7c3aed" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-purple)"/>
  <text x="592" y="581" text-anchor="middle" font-size="11" fill="#7c3aed">invoice_id + checkoutLink + expiration</text>

  <!-- 3d: thebrain-mcp stores pending -->
  <rect x="435" y="595" width="110" height="18" rx="3" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
  <text x="490" y="607" text-anchor="middle" font-size="9" fill="#166534">add to pending_invoices</text>

  <!-- 3e: thebrain-mcp → Claude: return -->
  <line x1="483" y1="626" x2="118" y2="626" stroke="#7c3aed" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-purple)"/>
  <text x="298" y="621" text-anchor="middle" font-size="11" fill="#7c3aed">invoice_id + checkout_link + expiry</text>

  <!-- 3f: User pays via Lightning wallet — out-of-band mobile interaction -->
  <rect x="40" y="640" width="200" height="36" rx="5" fill="#fae8ff" stroke="#7c3aed" stroke-width="1.2"/>
  <text x="140" y="655" text-anchor="middle" font-size="10" font-weight="bold" fill="#581c87">User opens Lightning wallet</text>
  <text x="140" y="668" text-anchor="middle" font-size="9" fill="#7c3aed">(WoS, Phoenix, Zeus) — scans QR, pays</text>

  <!-- 3g: Claude → thebrain-mcp: check_payment -->
  <line x1="115" y1="693" x2="482" y2="693" stroke="#7c3aed" stroke-width="1.5" marker-end="url(#arrow-purple)"/>
  <text x="298" y="688" text-anchor="middle" font-size="11" fill="#7c3aed">check_payment(invoice_id)</text>

  <!-- 3h: thebrain-mcp → BTCPay: GET invoice -->
  <line x1="498" y1="713" x2="687" y2="713" stroke="#7c3aed" stroke-width="1.5" marker-end="url(#arrow-purple)"/>
  <text x="592" y="708" text-anchor="middle" font-size="11" fill="#7c3aed">GET /stores/{id}/invoices/{invoiceId}</text>

  <!-- 3i: BTCPay → thebrain-mcp: settled status -->
  <line x1="688" y1="733" x2="498" y2="733" stroke="#7c3aed" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-purple)"/>
  <text x="592" y="728" text-anchor="middle" font-size="11" fill="#7c3aed">status: Settled, amount: 1000</text>

  <!-- 3j: thebrain-mcp: credit ledger -->
  <rect x="420" y="743" width="140" height="18" rx="3" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
  <text x="490" y="755" text-anchor="middle" font-size="9" fill="#166534">credit 1,000 × tier multiplier → LedgerCache</text>

  <!-- 3k: thebrain-mcp → Claude: balance -->
  <line x1="483" y1="775" x2="118" y2="775" stroke="#16a34a" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-green)"/>
  <text x="298" y="770" text-anchor="middle" font-size="11" fill="#16a34a">+1,000 credits granted (balance: 1,000 sats)</text>

  <!-- ═══ Phase 4: Monetized Tool Execution ═══ -->
  <rect x="30" y="803" width="1040" height="150" rx="4" fill="#fff7ed" fill-opacity="0.5" stroke="#fed7aa" stroke-width="1"/>
  <text x="45" y="823" font-size="13" font-weight="bold" fill="#9a3412">Phase 4: Monetized Tool Execution</text>
  <text x="330" y="823" font-size="10" fill="#64748b">(tool gating — Task 21 Phase 2, implemented)</text>

  <line x1="115" y1="846" x2="482" y2="846" stroke="#ea580c" stroke-width="1.5" marker-end="url(#arrow-orange)"/>
  <text x="298" y="841" text-anchor="middle" font-size="11" fill="#ea580c">brain_query("MATCH (p:Person) RETURN p")</text>

  <rect x="430" y="856" width="120" height="28" rx="3" fill="#fff7ed" stroke="#ea580c" stroke-width="1"/>
  <text x="490" y="868" text-anchor="middle" font-size="10" fill="#9a3412">LedgerCache: balance ≥ 10?</text>
  <text x="490" y="880" text-anchor="middle" font-size="10" fill="#16a34a" font-weight="bold">debit 10 sats</text>

  <line x1="498" y1="894" x2="887" y2="894" stroke="#e11d48" stroke-width="1.5" marker-end="url(#arrow-red)"/>
  <text x="692" y="889" text-anchor="middle" font-size="11" fill="#e11d48">execute query (with user's API key)</text>

  <line x1="888" y1="914" x2="498" y2="914" stroke="#e11d48" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-red)"/>
  <text x="692" y="909" text-anchor="middle" font-size="11" fill="#e11d48">thought results</text>

  <line x1="483" y1="938" x2="118" y2="938" stroke="#16a34a" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-green)"/>
  <text x="298" y="933" text-anchor="middle" font-size="11" fill="#16a34a">query results (balance: 990 sats)</text>

  <!-- Legend -->
  <rect x="30" y="963" width="1040" height="98" rx="4" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/>
  <text x="50" y="983" font-size="12" font-weight="bold" fill="#334155">Key Principles</text>

  <circle cx="55" cy="1000" r="4" fill="#2563eb"/>
  <text x="68" y="1004" font-size="11" fill="#334155">OAuth identity preserved throughout — every request carries Bearer token via Horizon</text>

  <circle cx="55" cy="1018" r="4" fill="#7c3aed"/>
  <text x="68" y="1022" font-size="11" fill="#334155">Payment is complementary to auth — identity + payment are separate layers, not competing</text>

  <circle cx="55" cy="1036" r="4" fill="#16a34a"/>
  <text x="68" y="1040" font-size="11" fill="#334155">Self-sovereign: BTCPay Server + Lightning Node owned by operator — zero KYC, instant settlement</text>

  <circle cx="55" cy="1054" r="4" fill="#ea580c"/>
  <text x="68" y="1058" font-size="11" fill="#334155">All amounts in satoshis — integer arithmetic only, no USD peg, no floats in the credit path</text>
</svg>
